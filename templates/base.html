<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stock Widget</title>
    <link rel="stylesheet" href="static/css/styles.css" />
    <link rel="stylesheet" href="static/css/data-tables.css" />
  </head>

  <body>
    <div class="content">
      <div class="toolbox">
        <div>
          [<code id="tariff"></code>] <b>–ë–ê–õ–ê–ù–°</b>: <code id="balance">{{ balance }}</code> RUB
        </div>
        <div>
          <button class="btn" id="delete-acc">üî® –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã</button>
          <button class="btn" id="open-acc">üöÄ –û—Ç–∫—Ä—ã—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
          <button class="btn" id="add-money">üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
        </div>
        <div id="exchange-timer">–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–µ–º–µ–Ω–∏...</div>
      </div>
      <div id="stock-widget" class="stock-widget">
        <table>
          <thead>
            <tr>
              <th></th>
              <th>FIGI</th>
              <th>Analytics</th>
              <th>Ticker</th>
              <th style="text-align: right">Price (RUB)</th>
            </tr>
          </thead>
          <tbody>
            <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
          </tbody>
        </table>
      </div>
    </div>
    <div class="stock-widget" style="display: none;">
      <table class="purchaise">
        <thead>
          <tr>
            <th>Instrument</th>
            <th>Purchase (RUB)</th>
            <th>Quantity</th>
            <th>All time %</th>
            <th>Profit (RUB)</th>
          </tr>
        </thead>
        <tbody>
          <tr id="purchase-ZAYM">
            <td>ZAYM</td>
            <td>230.29</td>
            <td>170</td>
            <td></td>
            <td></td>
          </tr>
          <tr id="purchase-VTBR">
            <td>VTBR</td>
            <td>0.023215</td>
            <td>1120000</td>
            <td></td>
            <td></td>
          </tr>
          <tr id="purchase-GMKN">
            <td>GMKN</td>
            <td>154.56</td>
            <td>130</td>
            <td></td>
            <td></td>
          </tr>
          <tr id="purchase-WUSH">
            <td>WUSH</td>
            <td>221.79</td>
            <td>120</td>
            <td></td>
            <td></td>
          </tr>
          <tr id="purchase-TMOS">
            <td>TMOS</td>
            <td>6.72</td>
            <td>3832</td>
            <td></td>
            <td></td>
          </tr>
          <tr id="purchase-TGLD">
            <td>TGLD</td>
            <td>7.49</td>
            <td>5000</td>
            <td></td>
            <td></td>
          </tr>
          <tr id="purchase-TLCB">
            <td>TLCB</td>
            <td>10.32</td>
            <td>3234</td>
            <td></td>
            <td></td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="tabs">
      <ul class="tab-links"></ul>
      <div class="tab-content"></div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css" />
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/db.js"></script>
    <script src="/static/js/bot.js"></script>
    <script src="/static/js/sock.js"></script>
    <script src="/static/js/toolbox.js"></script>
    <script src="/static/js/chart.js"></script>
    <script src="/static/js/analyse.js"></script>

    <script>
        const instruments = {{ instruments|tojson }};
        const token = "{{ token }}";
        const botToken = "{{ bot_token }}";
        const chatId = "{{ chat_id }}";
        const protocols = ['json', token];
        const figiList = {{ figi_list|tojson }};

        // websocket
        const ws = new WebSocket(
            'wss://invest-public-api.tinkoff.ru/ws/tinkoff.public.invest.api.contract.v1.MarketDataStreamService/MarketDataStream',
            protocols
        );

        // Data Tables
        $(document).ready( function () {
          $('.purchaise').DataTable({
              "paging": true,
              "ordering": true,
              "info": true,
              "searching": true,
              "order": [[4, "asc"]] // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ –ø–µ—Ä–≤–æ–º—É —Å—Ç–æ–ª–±—Ü—É –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
          });
        });

        // analytics
        $('#stock-widget tbody').on('click', 'tr[id^="stock-"]', function() {
          // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤—ã–∑—ã–≤–∞–µ–º analyzeAllTickers –∏ selectBestTradingOptions
          Promise.all([analyzeAllTickers(), selectBestTradingOptions()])
              .then(results => {
                let trId = $(this).attr('id');
    
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞, —É–¥–∞–ª—è—è –ø—Ä–µ—Ñ–∏–∫—Å 'stock-'
                let instrumentName = trId.substring(6); 
                const res = results[0][instrumentName];
                const msg = `–ü–æ–ª—É—á–µ–Ω–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ ${instrumentName}: ${res}% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ —Ä–æ—Å—Ç–∞ —Ü–µ–Ω—ã`;
                sendMessage(msg);
              })
              .catch(error => {
                  console.error('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:', error);
              });
      });
    </script>
  </body>
</html>
